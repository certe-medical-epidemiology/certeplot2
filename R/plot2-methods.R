# ===================================================================== #
#  An R package by Certe:                                               #
#  https://github.com/certe-medical-epidemiology                        #
#                                                                       #
#  Licensed as GPL-v2.0.                                                #
#                                                                       #
#  Developed at non-profit organisation Certe Medical Diagnostics &     #
#  Advice, department of Medical Epidemiology.                          #
#                                                                       #
#  This R package is free software; you can freely use and distribute   #
#  it for both personal and commercial purposes under the terms of the  #
#  GNU General Public License version 2.0 (GNU GPL-2), as published by  #
#  the Free Software Foundation.                                        #
#                                                                       #
#  We created this package for both routine data analysis and academic  #
#  research and it was publicly released in the hope that it will be    #
#  useful, but it comes WITHOUT ANY WARRANTY OR LIABILITY.              #
# ===================================================================== #

#' Methods for [plot2()]
#' 
#' These are the implemented methods for different S3 classes to be used in [plot2()]. Since they have an extensive list of arguments, they are placed here on a separate manual page.
#' @rdname plot2-methods
#' @name plot2-methods
#' @inheritParams plot2
#' @importFrom ggplot2 fortify
#' @export
plot2.default <- function(.data,
                          x = NULL,
                          y = NULL,
                          category = NULL,
                          facet = NULL,
                          type = NULL,
                          x.title = TRUE,
                          y.title = TRUE,
                          category.title = NULL,
                          title = NULL,
                          subtitle = NULL,
                          caption = NULL,
                          tag = NULL,
                          title.linelength = 60,
                          title.colour = "black",
                          subtitle.linelength = 60,
                          subtitle.colour = "grey35",
                          na.replace = "",
                          na.rm = FALSE,
                          facet.position = "top",
                          facet.fill = NULL,
                          facet.bold = TRUE,
                          facet.italic = FALSE,
                          facet.size = 10,
                          facet.margin = 8,
                          facet.repeat_lbls_x = TRUE,
                          facet.repeat_lbls_y = TRUE,
                          facet.fixed_y = NULL,
                          facet.fixed_x = TRUE,
                          facet.drop = FALSE,
                          facet.nrow = NULL,
                          facet.relative = FALSE,
                          x.date_breaks = NULL,
                          x.date_labels = NULL,
                          category.focus = NULL,
                          colour = "certe",
                          colour_fill = NULL,
                          colour_opacity = 0,
                          x.lbl_angle = 0,
                          x.lbl_align = NULL,
                          x.lbl_italic = FALSE,
                          x.lbl_taxonomy = FALSE,
                          x.remove = FALSE,
                          x.position = "bottom",
                          x.max_items = Inf,
                          x.max_txt = "(rest, x%n)",
                          category.max_items = Inf,
                          category.max_txt = "(rest, x%n)",
                          facet.max_items = Inf,
                          facet.max_txt = "(rest, x%n)",
                          x.breaks = NULL,
                          x.n_breaks = NULL,
                          x.trans = "identity",
                          x.expand = NULL,
                          x.limits = NULL,
                          x.labels = NULL,
                          x.character = NULL,
                          x.drop = FALSE,
                          x.mic = FALSE,
                          x.zoom = FALSE,
                          y.remove = FALSE,
                          y.24h = FALSE,
                          y.age = FALSE,
                          y.scientific = NULL,
                          y.percent = FALSE,
                          y.percent_break = 0.1,
                          y.breaks = NULL,
                          y.n_breaks = NULL,
                          y.limits = NULL,
                          y.labels = NULL,
                          y.expand = NULL,
                          y.trans = "identity",
                          y.position = "left",
                          y.zoom = FALSE,
                          category.labels = NULL,
                          category.percent = FALSE,
                          category.breaks = NULL,
                          category.limits = NULL,
                          category.expand = 0,
                          category.midpoint = NULL,
                          category.trans = "identity",
                          x.sort = NULL,
                          category.sort = TRUE,
                          facet.sort = TRUE,
                          datalabels = TRUE,
                          datalabels.round = ifelse(y.percent, 2, 1),
                          datalabels.format = "%n",
                          datalabels.colour = "grey25",
                          datalabels.colour_fill = NULL,
                          datalabels.size = (3 * text_factor),
                          datalabels.angle = 0,
                          decimal.mark = ",",
                          big.mark = ifelse(decimal.mark == ",", ".", ","),
                          summarise_function = base::sum,
                          stacked = FALSE,
                          stackedpercent = FALSE,
                          horizontal = FALSE,
                          reverse = horizontal,
                          smooth = NULL,
                          smooth.method = NULL,
                          smooth.formula = NULL,
                          smooth.se = TRUE,
                          smooth.level = 0.95,
                          smooth.alpha = 0.1,
                          smooth.size = 0.75,
                          smooth.linetype = 3,
                          size = NULL,
                          linetype = 1,
                          binwidth = NULL,
                          width = NULL,
                          jitter_seed = NA,
                          violin_scale = "count",
                          legend.position = NULL,
                          legend.title = NULL, # TRUE in numeric categories
                          legend.reverse = FALSE,
                          legend.barheight = 6,
                          legend.barwidth = 1.5,
                          legend.nbin = 300,
                          legend.italic = FALSE,
                          zoom = FALSE,
                          sep = " / ",
                          print = FALSE,
                          text_factor = 1,
                          font = getOption("plot2.font"),
                          theme = getOption("plot2.theme", "theme_minimal2"),
                          background = "white",
                          markdown = TRUE,
                          ...) {
  
  if (is.function(.data)) {
    stop("`plot2()` does not support functions to be plotted", call. = FALSE)
  }
  
  # ggplot2's fortify() will try to make this a data.frame,
  # so that plot2.data.frame() can be called
  new_df <- tryCatch(fortify(.data), error = function(e) NULL)
  if (is.null(new_df)) {
    # then try to make a regular data.frame
    new_df <- tryCatch(as.data.frame(.data, stringsAsFactors = FALSE),
                       error = function(e) NULL)
    if (!is.data.frame(new_df)) {
      stop("Unable to initialise plot2(): input class '", paste(class(.data), collapse = "/"), "' is unsupported",
           call. = FALSE)
    }
    plot2_warning("Input class '", paste(class(.data), collapse = "/"), "' was transformed using as.data.frame()")
  }
  
  plot2_exec(new_df,
             x = {{ x }},
             y = {{ y }},
             category = {{ category }},
             facet = {{ facet }},
             type = type,
             x.title = {{ x.title }},
             y.title = {{ y.title }},
             category.title = {{ category.title }},
             title = {{ title }},
             subtitle = {{ subtitle }},
             caption = {{ caption }},
             tag = {{ tag }},
             title.linelength = title.linelength,
             title.colour = title.colour,
             subtitle.linelength = subtitle.linelength,
             subtitle.colour = subtitle.colour,
             na.replace = na.replace,
             na.rm = na.rm,
             facet.position = facet.position,
             facet.fill = facet.fill,
             facet.bold = facet.bold,
             facet.italic = facet.italic,
             facet.size = facet.size,
             facet.margin = facet.margin,
             facet.repeat_lbls_x = facet.repeat_lbls_x,
             facet.repeat_lbls_y = facet.repeat_lbls_y,
             facet.fixed_y = facet.fixed_y,
             facet.fixed_x = facet.fixed_x,
             facet.drop = facet.drop,
             facet.nrow = facet.nrow,
             facet.relative = facet.relative,
             x.date_breaks = x.date_breaks,
             x.date_labels = x.date_labels,
             category.focus = category.focus,
             colour = colour,
             colour_fill = colour_fill,
             colour_opacity = colour_opacity,
             x.lbl_angle = x.lbl_angle,
             x.lbl_align = x.lbl_align,
             x.lbl_italic = x.lbl_italic,
             x.lbl_taxonomy = x.lbl_taxonomy,
             x.remove = x.remove,
             x.position = x.position,
             x.max_items = x.max_items,
             x.max_txt = x.max_txt,
             category.max_items = category.max_items,
             category.max_txt = category.max_txt,
             facet.max_items = facet.max_items,
             facet.max_txt = facet.max_txt,
             x.breaks = x.breaks,
             x.n_breaks = x.n_breaks,
             x.trans = x.trans,
             x.expand = x.expand,
             x.limits = x.limits,
             x.labels = x.labels,
             x.character = x.character,
             x.drop = x.drop,
             x.mic = x.mic,
             x.zoom = x.zoom,
             y.remove = y.remove,
             y.24h = y.24h,
             y.age = y.age,
             y.scientific = y.scientific,
             y.percent = y.percent,
             y.percent_break = y.percent_break,
             y.breaks = y.breaks,
             y.n_breaks = y.n_breaks,
             y.limits = y.limits,
             y.labels = y.labels,
             y.expand = y.expand,
             y.trans = y.trans,
             y.position = y.position,
             y.zoom = y.zoom,
             category.labels = category.labels,
             category.percent = category.percent,
             category.breaks = category.breaks,
             category.limits = category.limits,
             category.expand = category.expand,
             category.midpoint = category.midpoint,
             category.trans = category.trans,
             x.sort = x.sort,
             category.sort = category.sort,
             facet.sort = facet.sort,
             datalabels = {{ datalabels }},
             datalabels.round = datalabels.round,
             datalabels.colour = datalabels.colour,
             datalabels.format = datalabels.format,
             datalabels.colour_fill = datalabels.colour_fill,
             datalabels.size = datalabels.size,
             datalabels.angle = datalabels.angle,
             decimal.mark = decimal.mark,
             big.mark = big.mark,
             summarise_function = summarise_function,
             stacked = stacked,
             stackedpercent = stackedpercent,
             horizontal = horizontal,
             reverse = reverse,
             smooth = smooth,
             smooth.method = smooth.method,
             smooth.formula = smooth.formula,
             smooth.se = smooth.se,
             smooth.level = smooth.level,
             smooth.alpha = smooth.alpha,
             smooth.size = smooth.size,
             smooth.linetype = smooth.linetype,
             size = size,
             linetype = linetype,
             binwidth = binwidth,
             width = width,
             jitter_seed = jitter_seed,
             violin_scale = violin_scale,
             legend.position = legend.position,
             legend.title = {{ legend.title }},
             legend.reverse = legend.reverse,
             legend.barheight = legend.barheight,
             legend.barwidth = legend.barwidth,
             legend.nbin = legend.nbin,
             legend.italic = legend.italic,
             zoom = zoom,
             sep = sep,
             print = print,
             text_factor = text_factor,
             font = font,
             theme = theme,
             background = background,
             markdown = markdown,
             `_misses.x` = missing(x),
             `_misses.y` = missing(y),
             `_misses.category` = missing(category),
             `_misses.facet` = missing(facet),
             `_misses.datalabels` = missing(datalabels),
             `_misses.colour_fill` = missing(colour_fill),
             `_misses.x.title` = missing(x.title),
             `_misses.y.title` = missing(y.title),
             `_misses.title` = missing(title),
             `_misses.subtitle` = missing(subtitle),
             `_misses.tag` = missing(tag),
             `_misses.caption` = missing(caption),
             `_misses.y.percent` = missing(y.percent),
             `_misses.y.percent_break` = missing(y.percent_break),
             `_misses.x.zoom` = missing(x.zoom),
             `_misses.x.max_items` = missing(x.max_items),
             `_misses.facet.fixed_x` = missing(facet.fixed_x),
             `_label.x` = deparse(substitute(x)),
             `_label.y` = deparse(substitute(y)),
             `_label.category` = deparse(substitute(category)),
             `_label.facet` = deparse(substitute(facet)),
             `_summarise_fn_name` = deparse(substitute(summarise_function)),
             ...)
}

#' @rdname plot2-methods
#' @export
plot2.numeric <- function(.data,
                          x = NULL,
                          y = NULL,
                          category = NULL,
                          facet = NULL,
                          type = NULL,
                          x.title = TRUE,
                          y.title = TRUE,
                          category.title = NULL,
                          title = NULL,
                          subtitle = NULL,
                          caption = NULL,
                          tag = NULL,
                          title.linelength = 60,
                          title.colour = "black",
                          subtitle.linelength = 60,
                          subtitle.colour = "grey35",
                          na.replace = "",
                          na.rm = FALSE,
                          facet.position = "top",
                          facet.fill = NULL,
                          facet.bold = TRUE,
                          facet.italic = FALSE,
                          facet.size = 10,
                          facet.margin = 8,
                          facet.repeat_lbls_x = TRUE,
                          facet.repeat_lbls_y = TRUE,
                          facet.fixed_y = NULL,
                          facet.fixed_x = TRUE,
                          facet.drop = FALSE,
                          facet.nrow = NULL,
                          facet.relative = FALSE,
                          x.date_breaks = NULL,
                          x.date_labels = NULL,
                          category.focus = NULL,
                          colour = "certe",
                          colour_fill = NULL,
                          colour_opacity = 0,
                          x.lbl_angle = 0,
                          x.lbl_align = NULL,
                          x.lbl_italic = FALSE,
                          x.lbl_taxonomy = FALSE,
                          x.remove = FALSE,
                          x.position = "bottom",
                          x.max_items = Inf,
                          x.max_txt = "(rest, x%n)",
                          category.max_items = Inf,
                          category.max_txt = "(rest, x%n)",
                          facet.max_items = Inf,
                          facet.max_txt = "(rest, x%n)",
                          x.breaks = NULL,
                          x.n_breaks = NULL,
                          x.trans = "identity",
                          x.expand = NULL,
                          x.limits = NULL,
                          x.labels = NULL,
                          x.character = NULL,
                          x.drop = FALSE,
                          x.mic = FALSE,
                          x.zoom = FALSE,
                          y.remove = FALSE,
                          y.24h = FALSE,
                          y.age = FALSE,
                          y.scientific = NULL,
                          y.percent = FALSE,
                          y.percent_break = 0.1,
                          y.breaks = NULL,
                          y.n_breaks = NULL,
                          y.limits = NULL,
                          y.labels = NULL,
                          y.expand = NULL,
                          y.trans = "identity",
                          y.position = "left",
                          y.zoom = FALSE,
                          category.labels = NULL,
                          category.percent = FALSE,
                          category.breaks = NULL,
                          category.limits = NULL,
                          category.expand = 0,
                          category.midpoint = NULL,
                          category.trans = "identity",
                          x.sort = NULL,
                          category.sort = TRUE,
                          facet.sort = TRUE,
                          datalabels = FALSE,
                          datalabels.round = ifelse(y.percent, 2, 1),
                          datalabels.format = "%n",
                          datalabels.colour = "grey25",
                          datalabels.colour_fill = NULL,
                          datalabels.size = (3 * text_factor),
                          datalabels.angle = 0,
                          decimal.mark = ",",
                          big.mark = ifelse(decimal.mark == ",", ".", ","),
                          summarise_function = base::sum,
                          stacked = FALSE,
                          stackedpercent = FALSE,
                          horizontal = FALSE,
                          reverse = horizontal,
                          smooth = NULL,
                          smooth.method = NULL,
                          smooth.formula = NULL,
                          smooth.se = TRUE,
                          smooth.level = 0.95,
                          smooth.alpha = 0.1,
                          smooth.size = 0.75,
                          smooth.linetype = 3,
                          size = NULL,
                          linetype = 1,
                          binwidth = NULL,
                          width = NULL,
                          jitter_seed = NA,
                          violin_scale = "count",
                          legend.position = NULL,
                          legend.title = NULL, # TRUE in numeric categories
                          legend.reverse = FALSE,
                          legend.barheight = 6,
                          legend.barwidth = 1.5,
                          legend.nbin = 300,
                          legend.italic = FALSE,
                          zoom = FALSE,
                          sep = " / ",
                          print = FALSE,
                          text_factor = 1,
                          font = getOption("plot2.font"),
                          theme = getOption("plot2.theme", "theme_minimal2"),
                          background = "white",
                          markdown = TRUE,
                          ...) {
  y_deparse <- deparse(substitute(.data))
  if (missing(.data)) {
    .data <- y
    y_deparse <- "y"
  }
  if (geom_is_continuous_x(validate_type(type))) {
    df <- data.frame(x = .data, stringsAsFactors = FALSE)
  } else {
    df <- data.frame(y = .data, stringsAsFactors = FALSE)
    colnames(df) <- ifelse(y_deparse == "x", "y", y_deparse) # support `plot2(x)` if x is a dbl vector
    if (missing(x)) {
      df$x <- seq_len(nrow(df))
    } else {
      df$x <- x
    }
  }
  
  if (is.null(type)) {
    type <- getOption("plot2.default_type", "geom_col")
    plot2_message("Using ", font_blue("type = \"", gsub("geom_", "", type), "\"", collapse = NULL), 
                  font_black(" as the default"))
  }
  
  plot2_exec(df,
             x = x,
             y = {{ y }},
             category = {{ category }},
             facet = {{ facet }},
             type = type,
             x.title = {{ x.title }},
             y.title = {{ y.title }},
             category.title = {{ category.title }},
             title = {{ title }},
             subtitle = {{ subtitle }},
             caption = {{ caption }},
             tag = {{ tag }},
             title.linelength = title.linelength,
             title.colour = title.colour,
             subtitle.linelength = subtitle.linelength,
             subtitle.colour = subtitle.colour,
             na.replace = na.replace,
             na.rm = na.rm,
             facet.position = facet.position,
             facet.fill = facet.fill,
             facet.bold = facet.bold,
             facet.italic = facet.italic,
             facet.size = facet.size,
             facet.margin = facet.margin,
             facet.repeat_lbls_x = facet.repeat_lbls_x,
             facet.repeat_lbls_y = facet.repeat_lbls_y,
             facet.fixed_y = facet.fixed_y,
             facet.fixed_x = facet.fixed_x,
             facet.drop = facet.drop,
             facet.nrow = facet.nrow,
             facet.relative = facet.relative,
             x.date_breaks = x.date_breaks,
             x.date_labels = x.date_labels,
             category.focus = category.focus,
             colour = colour,
             colour_fill = colour_fill,
             colour_opacity = colour_opacity,
             x.lbl_angle = x.lbl_angle,
             x.lbl_align = x.lbl_align,
             x.lbl_italic = x.lbl_italic,
             x.lbl_taxonomy = x.lbl_taxonomy,
             x.remove = x.remove,
             x.position = x.position,
             x.max_items = x.max_items,
             x.max_txt = x.max_txt,
             category.max_items = category.max_items,
             category.max_txt = category.max_txt,
             facet.max_items = facet.max_items,
             facet.max_txt = facet.max_txt,
             x.breaks = x.breaks,
             x.n_breaks = x.n_breaks,
             x.trans = x.trans,
             x.expand = x.expand,
             x.limits = x.limits,
             x.labels = x.labels,
             x.character = x.character,
             x.drop = x.drop,
             x.mic = x.mic,
             x.zoom = x.zoom,
             y.remove = y.remove,
             y.24h = y.24h,
             y.age = y.age,
             y.scientific = y.scientific,
             y.percent = y.percent,
             y.percent_break = y.percent_break,
             y.breaks = y.breaks,
             y.n_breaks = y.n_breaks,
             y.limits = y.limits,
             y.labels = y.labels,
             y.expand = y.expand,
             y.trans = y.trans,
             y.position = y.position,
             y.zoom = y.zoom,
             category.labels = category.labels,
             category.percent = category.percent,
             category.breaks = category.breaks,
             category.limits = category.limits,
             category.expand = category.expand,
             category.midpoint = category.midpoint,
             category.trans = category.trans,
             x.sort = x.sort,
             category.sort = category.sort,
             facet.sort = facet.sort,
             datalabels = {{ datalabels }},
             datalabels.round = datalabels.round,
             datalabels.colour = datalabels.colour,
             datalabels.format = datalabels.format,
             datalabels.colour_fill = datalabels.colour_fill,
             datalabels.size = datalabels.size,
             datalabels.angle = datalabels.angle,
             decimal.mark = decimal.mark,
             big.mark = big.mark,
             summarise_function = summarise_function,
             stacked = stacked,
             stackedpercent = stackedpercent,
             horizontal = horizontal,
             reverse = reverse,
             smooth = smooth,
             smooth.method = smooth.method,
             smooth.formula = smooth.formula,
             smooth.se = smooth.se,
             smooth.level = smooth.level,
             smooth.alpha = smooth.alpha,
             smooth.size = smooth.size,
             smooth.linetype = smooth.linetype,
             size = size,
             linetype = linetype,
             binwidth = binwidth,
             width = width,
             jitter_seed = jitter_seed,
             violin_scale = violin_scale,
             legend.position = legend.position,
             legend.title = {{ legend.title }},
             legend.reverse = legend.reverse,
             legend.barheight = legend.barheight,
             legend.barwidth = legend.barwidth,
             legend.nbin = legend.nbin,
             legend.italic = legend.italic,
             zoom = zoom,
             sep = sep,
             print = print,
             text_factor = text_factor,
             font = font,
             theme = theme,
             background = background,
             markdown = markdown,
             `_misses.x` = missing(x),
             `_misses.y` = missing(y),
             `_misses.category` = missing(category),
             `_misses.facet` = missing(facet),
             `_misses.datalabels` = missing(datalabels),
             `_misses.colour_fill` = missing(colour_fill),
             `_misses.x.title` = missing(x.title),
             `_misses.y.title` = missing(y.title),
             `_misses.title` = missing(title),
             `_misses.subtitle` = missing(subtitle),
             `_misses.tag` = missing(tag),
             `_misses.caption` = missing(caption),
             `_misses.y.percent` = missing(y.percent),
             `_misses.y.percent_break` = missing(y.percent_break),
             `_misses.x.zoom` = missing(x.zoom),
             `_misses.x.max_items` = missing(x.max_items),
             `_misses.facet.fixed_x` = missing(facet.fixed_x),
             `_label.x` = deparse(substitute(x)),
             `_label.y` = deparse(substitute(y)),
             `_label.category` = deparse(substitute(category)),
             `_label.facet` = deparse(substitute(facet)),
             `_summarise_fn_name` = deparse(substitute(summarise_function)),
             ...)
}

#' @rdname plot2-methods
#' @export
plot2.freq <- function(.data,
                       x = .data$item,
                       y = .data$count,
                       category = NULL,
                       facet = NULL,
                       type = NULL,
                       x.title = "Item",
                       y.title = "Count",
                       category.title = TRUE,
                       title = NULL,
                       subtitle = NULL,
                       caption = NULL,
                       tag = NULL,
                       title.linelength = 60,
                       title.colour = "black",
                       subtitle.linelength = 60,
                       subtitle.colour = "grey35",
                       na.replace = "",
                       na.rm = FALSE,
                       facet.position = "top",
                       facet.fill = NULL,
                       facet.bold = TRUE,
                       facet.italic = FALSE,
                       facet.size = 10,
                       facet.margin = 8,
                       facet.repeat_lbls_x = TRUE,
                       facet.repeat_lbls_y = TRUE,
                       facet.fixed_y = NULL,
                       facet.fixed_x = TRUE,
                       facet.drop = FALSE,
                       facet.nrow = NULL,
                       facet.relative = FALSE,
                       x.date_breaks = NULL,
                       x.date_labels = NULL,
                       category.focus = NULL,
                       colour = "certe",
                       colour_fill = NULL,
                       colour_opacity = 0,
                       x.lbl_angle = 0,
                       x.lbl_align = NULL,
                       x.lbl_italic = FALSE,
                       x.lbl_taxonomy = FALSE,
                       x.remove = FALSE,
                       x.position = "bottom",
                       x.max_items = Inf,
                       x.max_txt = "(rest, x%n)",
                       category.max_items = Inf,
                       category.max_txt = "(rest, x%n)",
                       facet.max_items = Inf,
                       facet.max_txt = "(rest, x%n)",
                       x.breaks = NULL,
                       x.n_breaks = NULL,
                       x.trans = "identity",
                       x.expand = NULL,
                       x.limits = NULL,
                       x.labels = NULL,
                       x.character = NULL,
                       x.drop = FALSE,
                       x.mic = FALSE,
                       x.zoom = FALSE,
                       y.remove = FALSE,
                       y.24h = FALSE,
                       y.age = FALSE,
                       y.scientific = NULL,
                       y.percent = FALSE,
                       y.percent_break = 0.1,
                       y.breaks = NULL,
                       y.n_breaks = NULL,
                       y.limits = NULL,
                       y.labels = NULL,
                       y.expand = NULL,
                       y.trans = "identity",
                       y.position = "left",
                       y.zoom = FALSE,
                       category.labels = NULL,
                       category.percent = FALSE,
                       category.breaks = NULL,
                       category.limits = NULL,
                       category.expand = 0,
                       category.midpoint = NULL,
                       category.trans = "identity",
                       x.sort = "freq-desc",
                       category.sort = TRUE,
                       facet.sort = TRUE,
                       datalabels = TRUE,
                       datalabels.round = ifelse(y.percent, 2, 1),
                       datalabels.format = "%n",
                       datalabels.colour = "grey25",
                       datalabels.colour_fill = NULL,
                       datalabels.size = (3 * text_factor),
                       datalabels.angle = 0,
                       decimal.mark = ",",
                       big.mark = ifelse(decimal.mark == ",", ".", ","),
                       summarise_function = base::sum,
                       stacked = FALSE,
                       stackedpercent = FALSE,
                       horizontal = FALSE,
                       reverse = horizontal,
                       smooth = NULL,
                       smooth.method = NULL,
                       smooth.formula = NULL,
                       smooth.se = TRUE,
                       smooth.level = 0.95,
                       smooth.alpha = 0.1,
                       smooth.size = 0.75,
                       smooth.linetype = 3,
                       size = NULL,
                       linetype = 1,
                       binwidth = NULL,
                       width = NULL,
                       jitter_seed = NA,
                       violin_scale = "count",
                       legend.position = NULL,
                       legend.title = NULL, # TRUE in numeric categories
                       legend.reverse = FALSE,
                       legend.barheight = 6,
                       legend.barwidth = 1.5,
                       legend.nbin = 300,
                       legend.italic = FALSE,
                       zoom = FALSE,
                       sep = " / ",
                       print = FALSE,
                       text_factor = 1,
                       font = getOption("plot2.font"),
                       theme = getOption("plot2.theme", "theme_minimal2"),
                       background = "white",
                       markdown = TRUE,
                       ...) {
  plot2_exec(as.data.frame(.data, stringsAsFactors = FALSE)[, 1:2, drop = FALSE],
             x = x,
             y = y,
             category = {{ category }},
             facet = {{ facet }},
             type = type,
             x.title = {{ x.title }},
             y.title = {{ y.title }},
             category.title = {{ category.title }},
             title = {{ title }},
             subtitle = {{ subtitle }},
             caption = {{ caption }},
             tag = {{ tag }},
             title.linelength = title.linelength,
             title.colour = title.colour,
             subtitle.linelength = subtitle.linelength,
             subtitle.colour = subtitle.colour,
             na.replace = na.replace,
             na.rm = na.rm,
             facet.position = facet.position,
             facet.fill = facet.fill,
             facet.bold = facet.bold,
             facet.italic = facet.italic,
             facet.size = facet.size,
             facet.margin = facet.margin,
             facet.repeat_lbls_x = facet.repeat_lbls_x,
             facet.repeat_lbls_y = facet.repeat_lbls_y,
             facet.fixed_y = facet.fixed_y,
             facet.fixed_x = facet.fixed_x,
             facet.drop = facet.drop,
             facet.nrow = facet.nrow,
             facet.relative = facet.relative,
             x.date_breaks = x.date_breaks,
             x.date_labels = x.date_labels,
             category.focus = category.focus,
             colour = colour,
             colour_fill = colour_fill,
             colour_opacity = colour_opacity,
             x.lbl_angle = x.lbl_angle,
             x.lbl_align = x.lbl_align,
             x.lbl_italic = x.lbl_italic,
             x.lbl_taxonomy = x.lbl_taxonomy,
             x.remove = x.remove,
             x.position = x.position,
             x.max_items = x.max_items,
             x.max_txt = x.max_txt,
             category.max_items = category.max_items,
             category.max_txt = category.max_txt,
             facet.max_items = facet.max_items,
             facet.max_txt = facet.max_txt,
             x.breaks = x.breaks,
             x.n_breaks = x.n_breaks,
             x.trans = x.trans,
             x.expand = x.expand,
             x.limits = x.limits,
             x.labels = x.labels,
             x.character = x.character,
             x.drop = x.drop,
             x.mic = x.mic,
             x.zoom = x.zoom,
             y.remove = y.remove,
             y.24h = y.24h,
             y.age = y.age,
             y.scientific = y.scientific,
             y.percent = y.percent,
             y.percent_break = y.percent_break,
             y.breaks = y.breaks,
             y.n_breaks = y.n_breaks,
             y.limits = y.limits,
             y.labels = y.labels,
             y.expand = y.expand,
             y.trans = y.trans,
             y.position = y.position,
             y.zoom = y.zoom,
             category.labels = category.labels,
             category.percent = category.percent,
             category.breaks = category.breaks,
             category.limits = category.limits,
             category.expand = category.expand,
             category.midpoint = category.midpoint,
             category.trans = category.trans,
             x.sort = x.sort,
             category.sort = category.sort,
             facet.sort = facet.sort,
             datalabels = {{ datalabels }},
             datalabels.round = datalabels.round,
             datalabels.colour = datalabels.colour,
             datalabels.format = datalabels.format,
             datalabels.colour_fill = datalabels.colour_fill,
             datalabels.size = datalabels.size,
             datalabels.angle = datalabels.angle,
             decimal.mark = decimal.mark,
             big.mark = big.mark,
             summarise_function = summarise_function,
             stacked = stacked,
             stackedpercent = stackedpercent,
             horizontal = horizontal,
             reverse = reverse,
             smooth = smooth,
             smooth.method = smooth.method,
             smooth.formula = smooth.formula,
             smooth.se = smooth.se,
             smooth.level = smooth.level,
             smooth.alpha = smooth.alpha,
             smooth.size = smooth.size,
             smooth.linetype = smooth.linetype,
             size = size,
             linetype = linetype,
             binwidth = binwidth,
             width = width,
             jitter_seed = jitter_seed,
             violin_scale = violin_scale,
             legend.position = legend.position,
             legend.title = {{ legend.title }},
             legend.reverse = legend.reverse,
             legend.barheight = legend.barheight,
             legend.barwidth = legend.barwidth,
             legend.nbin = legend.nbin,
             legend.italic = legend.italic,
             zoom = zoom,
             sep = sep,
             print = print,
             text_factor = text_factor,
             font = font,
             theme = theme,
             background = background,
             markdown = markdown,
             `_misses.x` = missing(x),
             `_misses.y` = missing(y),
             `_misses.category` = missing(category),
             `_misses.facet` = missing(facet),
             `_misses.datalabels` = missing(datalabels),
             `_misses.colour_fill` = missing(colour_fill),
             `_misses.x.title` = missing(x.title),
             `_misses.y.title` = missing(y.title),
             `_misses.title` = missing(title),
             `_misses.subtitle` = missing(subtitle),
             `_misses.tag` = missing(tag),
             `_misses.caption` = missing(caption),
             `_misses.y.percent` = missing(y.percent),
             `_misses.y.percent_break` = missing(y.percent_break),
             `_misses.x.zoom` = missing(x.zoom),
             `_misses.x.max_items` = missing(x.max_items),
             `_misses.facet.fixed_x` = missing(facet.fixed_x),
             `_label.x` = "item",
             `_label.y` = "count",
             `_label.category` = deparse(substitute(category)),
             `_label.facet` = deparse(substitute(facet)),
             `_summarise_fn_name` = deparse(substitute(summarise_function)),
             ...)
}

#' @rdname plot2-methods
#' @details For geographic information system (GIS) analysis, use the `sf` package with a data set containing geometries. The result can be used as input for [plot2()].
#' @param crs the coordinate reference system (CRS) to use. If this is not left blank, [sf::st_transform()] will be used to transform the geometric data to the new CRS.
#' @export
plot2.sf <- function(.data,
                     x = NULL,
                     y = NULL,
                     category = NULL,
                     facet = NULL,
                     type = NULL,
                     x.title = FALSE,
                     y.title = FALSE,
                     category.title = NULL,
                     title = NULL,
                     subtitle = NULL,
                     caption = NULL,
                     tag = NULL,
                     title.linelength = 60,
                     title.colour = "black",
                     subtitle.linelength = 60,
                     subtitle.colour = "grey35",
                     na.replace = "",
                     na.rm = FALSE,
                     facet.position = "top",
                     facet.fill = NULL,
                     facet.bold = TRUE,
                     facet.italic = FALSE,
                     facet.size = 10,
                     facet.margin = 8,
                     facet.repeat_lbls_x = TRUE,
                     facet.repeat_lbls_y = TRUE,
                     facet.fixed_y = NULL,
                     facet.fixed_x = TRUE,
                     facet.drop = FALSE,
                     facet.nrow = NULL,
                     facet.relative = FALSE,
                     x.date_breaks = NULL,
                     x.date_labels = NULL,
                     category.focus = NULL,
                     colour = "grey50",
                     colour_fill = c("white", "certeblauw"),
                     colour_opacity = 0,
                     x.lbl_angle = 0,
                     x.lbl_align = NULL,
                     x.lbl_italic = FALSE,
                     x.lbl_taxonomy = FALSE,
                     x.remove = FALSE,
                     x.position = "bottom",
                     x.max_items = Inf,
                     x.max_txt = "(rest, x%n)",
                     category.max_items = Inf,
                     category.max_txt = "(rest, x%n)",
                     facet.max_items = Inf,
                     facet.max_txt = "(rest, x%n)",
                     x.breaks = NULL,
                     x.n_breaks = NULL,
                     x.trans = "identity",
                     x.expand = 0,
                     x.limits = NULL,
                     x.labels = NULL,
                     x.character = NULL,
                     x.drop = FALSE,
                     x.mic = FALSE,
                     x.zoom = FALSE,
                     y.remove = FALSE,
                     y.24h = FALSE,
                     y.age = FALSE,
                     y.scientific = NULL,
                     y.percent = FALSE,
                     y.percent_break = 0.1,
                     y.breaks = NULL,
                     y.n_breaks = NULL,
                     y.limits = NULL,
                     y.labels = NULL,
                     y.expand = 0,
                     y.trans = "identity",
                     y.position = "left",
                     y.zoom = FALSE,
                     category.labels = NULL,
                     category.percent = FALSE,
                     category.breaks = NULL,
                     category.limits = NULL,
                     category.expand = 0,
                     category.midpoint = NULL,
                     category.trans = "identity",
                     x.sort = NULL,
                     category.sort = TRUE,
                     facet.sort = TRUE,
                     datalabels = TRUE,
                     datalabels.round = ifelse(y.percent, 2, 1),
                     datalabels.format = NULL,
                     datalabels.colour = "black",
                     datalabels.colour_fill = NULL,
                     datalabels.size = (3 * text_factor),
                     datalabels.angle = 0,
                     decimal.mark = ",",
                     big.mark = ifelse(decimal.mark == ",", ".", ","),
                     summarise_function = base::sum,
                     stacked = FALSE,
                     stackedpercent = FALSE,
                     horizontal = FALSE,
                     reverse = horizontal,
                     smooth = NULL,
                     smooth.method = NULL,
                     smooth.formula = NULL,
                     smooth.se = TRUE,
                     smooth.level = 0.95,
                     smooth.alpha = 0.1,
                     smooth.size = 0.75,
                     smooth.linetype = 3,
                     size = NULL,
                     linetype = 1,
                     binwidth = NULL,
                     width = NULL,
                     jitter_seed = NA,
                     violin_scale = "count",
                     legend.position = "right",
                     legend.title = NULL,
                     legend.reverse = FALSE,
                     legend.barheight = 6,
                     legend.barwidth = 1.5,
                     legend.nbin = 300,
                     legend.italic = FALSE,
                     zoom = FALSE,
                     sep = " / ",
                     print = FALSE,
                     text_factor = 1,
                     font = getOption("plot2.font"),
                     theme = theme_minimal2(panel.grid.major = element_blank(),
                                            panel.grid.minor = element_blank(),
                                            panel.border = element_blank(),
                                            plot.margin = unit(c(5, 5, -15, 5), units = "pt"),
                                            axis.title = element_blank(),
                                            axis.text = element_blank(),
                                            axis.line = element_blank(),
                                            axis.ticks = element_blank()),
                     background = "white",
                     markdown = TRUE,
                     crs = NULL,
                     ...) {
  if (!"sf" %in% rownames(utils::installed.packages())) {
    stop("plotting 'sf' objects with plot2() requires the 'sf' package", call. = FALSE)
  } else {
    loadNamespace("sf")
  }
  
  if (!inherits(.data, "sf")) {
    plot2_warning("Transforming plot data to an sf model using ", font_blue("sf::st_as_sf()"))
    .data <- sf::st_as_sf(.data)
  }
  if (!is.null(crs)) {
    .data <- sf::st_transform(.data, crs = crs)
  }
  
  if (!is.null(x)) {
    plot2_warning("In 'sf' plots, ", font_blue("x"), " will be ignored - did you mean ", font_blue("category"), "?")
  }
  if (!is.null(y)) {
    plot2_warning("In 'sf' plots, ", font_blue("y"), " will be ignored - did you mean ", font_blue("category"), "?")
  }
  
  df <- .data
  df$x <- ""
  df$y <- 0
  
  plot2_exec(.data = df,
             x = x,
             y = y,
             category = {{ category }},
             facet = {{ facet }},
             type = "sf",
             x.title = {{ x.title }},
             y.title = {{ y.title }},
             category.title = {{ category.title }},
             title = {{ title }},
             subtitle = {{ subtitle }},
             caption = {{ caption }},
             tag = {{ tag }},
             title.linelength = title.linelength,
             title.colour = title.colour,
             subtitle.linelength = subtitle.linelength,
             subtitle.colour = subtitle.colour,
             na.replace = na.replace,
             na.rm = na.rm,
             facet.position = facet.position,
             facet.fill = facet.fill,
             facet.bold = facet.bold,
             facet.italic = facet.italic,
             facet.size = facet.size,
             facet.margin = facet.margin,
             facet.repeat_lbls_x = facet.repeat_lbls_x,
             facet.repeat_lbls_y = facet.repeat_lbls_y,
             facet.fixed_y = facet.fixed_y,
             facet.fixed_x = facet.fixed_x,
             facet.drop = facet.drop,
             facet.nrow = facet.nrow,
             facet.relative = facet.relative,
             x.date_breaks = x.date_breaks,
             x.date_labels = x.date_labels,
             category.focus = category.focus,
             colour = colour,
             colour_fill = colour_fill,
             colour_opacity = colour_opacity,
             x.lbl_angle = x.lbl_angle,
             x.lbl_align = x.lbl_align,
             x.lbl_italic = x.lbl_italic,
             x.lbl_taxonomy = x.lbl_taxonomy,
             x.remove = x.remove,
             x.position = x.position,
             x.max_items = x.max_items,
             x.max_txt = x.max_txt,
             category.max_items = category.max_items,
             category.max_txt = category.max_txt,
             facet.max_items = facet.max_items,
             facet.max_txt = facet.max_txt,
             x.breaks = x.breaks,
             x.n_breaks = x.n_breaks,
             x.trans = x.trans,
             x.expand = x.expand,
             x.limits = x.limits,
             x.labels = x.labels,
             x.character = x.character,
             x.drop = x.drop,
             x.mic = x.mic,
             x.zoom = x.zoom,
             y.remove = y.remove,
             y.24h = y.24h,
             y.age = y.age,
             y.scientific = y.scientific,
             y.percent = y.percent,
             y.percent_break = y.percent_break,
             y.breaks = y.breaks,
             y.n_breaks = y.n_breaks,
             y.limits = y.limits,
             y.labels = y.labels,
             y.expand = y.expand,
             y.trans = y.trans,
             y.position = y.position,
             y.zoom = y.zoom,
             category.labels = category.labels,
             category.percent = category.percent,
             category.breaks = category.breaks,
             category.limits = category.limits,
             category.expand = category.expand,
             category.midpoint = category.midpoint,
             category.trans = category.trans,
             x.sort = x.sort,
             category.sort = category.sort,
             facet.sort = facet.sort,
             datalabels = {{ datalabels }},
             datalabels.round = datalabels.round,
             datalabels.colour = datalabels.colour,
             datalabels.format = datalabels.format,
             datalabels.colour_fill = datalabels.colour_fill,
             datalabels.size = datalabels.size,
             datalabels.angle = datalabels.angle,
             decimal.mark = decimal.mark,
             big.mark = big.mark,
             summarise_function = summarise_function,
             stacked = stacked,
             stackedpercent = stackedpercent,
             horizontal = horizontal,
             reverse = reverse,
             smooth = smooth,
             smooth.method = smooth.method,
             smooth.formula = smooth.formula,
             smooth.se = smooth.se,
             smooth.level = smooth.level,
             smooth.alpha = smooth.alpha,
             smooth.size = smooth.size,
             smooth.linetype = smooth.linetype,
             size = size,
             linetype = linetype,
             binwidth = binwidth,
             width = width,
             jitter_seed = jitter_seed,
             violin_scale = violin_scale,
             legend.position = legend.position,
             legend.title = {{ legend.title }},
             legend.reverse = legend.reverse,
             legend.barheight = legend.barheight,
             legend.barwidth = legend.barwidth,
             legend.nbin = legend.nbin,
             legend.italic = legend.italic,
             zoom = zoom,
             sep = sep,
             print = print,
             text_factor = text_factor,
             font = font,
             theme = theme,
             background = background,
             markdown = markdown,
             `_misses.x` = FALSE,
             `_misses.y` = FALSE,
             `_misses.category` = missing(category),
             `_misses.facet` = missing(facet),
             `_misses.datalabels` = missing(datalabels),
             `_misses.colour_fill` = missing(colour_fill),
             `_misses.x.title` = missing(x.title),
             `_misses.y.title` = missing(y.title),
             `_misses.title` = missing(title),
             `_misses.subtitle` = missing(subtitle),
             `_misses.tag` = missing(tag),
             `_misses.caption` = missing(caption),
             `_misses.y.percent` = missing(y.percent),
             `_misses.y.percent_break` = missing(y.percent_break),
             `_misses.x.zoom` = missing(x.zoom),
             `_misses.x.max_items` = missing(x.max_items),
             `_misses.facet.fixed_x` = missing(facet.fixed_x),
             `_label.x` = deparse(substitute(x)),
             `_label.y` = deparse(substitute(y)),
             `_label.category` = deparse(substitute(category)),
             `_label.facet` = deparse(substitute(facet)),
             `_summarise_fn_name` = deparse(substitute(summarise_function)),
             `_sf.column` = attributes(.data)$sf_column,
             ...)
}

#' @rdname plot2-methods
#' @importFrom dplyr is_grouped_df ungroup
#' @export
plot2.data.frame <- function(.data,
                             x = NULL,
                             y = NULL,
                             category = NULL,
                             facet = NULL,
                             type = NULL,
                             x.title = TRUE,
                             y.title = TRUE,
                             category.title = NULL,
                             title = NULL,
                             subtitle = NULL,
                             caption = NULL,
                             tag = NULL,
                             title.linelength = 60,
                             title.colour = "black",
                             subtitle.linelength = 60,
                             subtitle.colour = "grey35",
                             na.replace = "",
                             na.rm = FALSE,
                             facet.position = "top",
                             facet.fill = NULL,
                             facet.bold = TRUE,
                             facet.italic = FALSE,
                             facet.size = 10,
                             facet.margin = 8,
                             facet.repeat_lbls_x = TRUE,
                             facet.repeat_lbls_y = TRUE,
                             facet.fixed_y = NULL,
                             facet.fixed_x = TRUE,
                             facet.drop = FALSE,
                             facet.nrow = NULL,
                             facet.relative = FALSE,
                             x.date_breaks = NULL,
                             x.date_labels = NULL,
                             category.focus = NULL,
                             colour = "certe",
                             colour_fill = NULL,
                             colour_opacity = 0,
                             x.lbl_angle = 0,
                             x.lbl_align = NULL,
                             x.lbl_italic = FALSE,
                             x.lbl_taxonomy = FALSE,
                             x.remove = FALSE,
                             x.position = "bottom",
                             x.max_items = Inf,
                             x.max_txt = "(rest, x%n)",
                             category.max_items = Inf,
                             category.max_txt = "(rest, x%n)",
                             facet.max_items = Inf,
                             facet.max_txt = "(rest, x%n)",
                             x.breaks = NULL,
                             x.n_breaks = NULL,
                             x.trans = "identity",
                             x.expand = NULL,
                             x.limits = NULL,
                             x.labels = NULL,
                             x.character = NULL,
                             x.drop = FALSE,
                             x.mic = FALSE,
                             x.zoom = FALSE,
                             y.remove = FALSE,
                             y.24h = FALSE,
                             y.age = FALSE,
                             y.scientific = NULL,
                             y.percent = FALSE,
                             y.percent_break = 0.1,
                             y.breaks = NULL,
                             y.n_breaks = NULL,
                             y.limits = NULL,
                             y.labels = NULL,
                             y.expand = NULL,
                             y.trans = "identity",
                             y.position = "left",
                             y.zoom = FALSE,
                             category.labels = NULL,
                             category.percent = FALSE,
                             category.breaks = NULL,
                             category.limits = NULL,
                             category.expand = 0,
                             category.midpoint = NULL,
                             category.trans = "identity",
                             x.sort = NULL,
                             category.sort = TRUE,
                             facet.sort = TRUE,
                             datalabels = TRUE,
                             datalabels.round = ifelse(y.percent, 2, 1),
                             datalabels.format = "%n",
                             datalabels.colour = "grey25",
                             datalabels.colour_fill = NULL,
                             datalabels.size = (3 * text_factor),
                             datalabels.angle = 0,
                             decimal.mark = ",",
                             big.mark = ifelse(decimal.mark == ",", ".", ","),
                             summarise_function = base::sum,
                             stacked = FALSE,
                             stackedpercent = FALSE,
                             horizontal = FALSE,
                             reverse = horizontal,
                             smooth = NULL,
                             smooth.method = NULL,
                             smooth.formula = NULL,
                             smooth.se = TRUE,
                             smooth.level = 0.95,
                             smooth.alpha = 0.1,
                             smooth.size = 0.75,
                             smooth.linetype = 3,
                             size = NULL,
                             linetype = 1,
                             binwidth = NULL,
                             width = NULL,
                             jitter_seed = NA,
                             violin_scale = "count",
                             legend.position = NULL,
                             legend.title = NULL, # TRUE in numeric categories
                             legend.reverse = FALSE,
                             legend.barheight = 6,
                             legend.barwidth = 1.5,
                             legend.nbin = 300,
                             legend.italic = FALSE,
                             zoom = FALSE,
                             sep = " / ",
                             print = FALSE,
                             text_factor = 1,
                             font = getOption("plot2.font"),
                             theme = getOption("plot2.theme", "theme_minimal2"),
                             background = "white",
                             markdown = TRUE,
                             ...) {
  
  if (isTRUE(is_grouped_df(.data))) {
    .data <- ungroup(.data)
  }
  
  plot2_exec(.data = .data,
             x = {{ x }},
             y = {{ y }},
             category = {{ category }},
             facet = {{ facet }},
             type = type,
             x.title = {{ x.title }},
             y.title = {{ y.title }},
             category.title = {{ category.title }},
             title = {{ title }},
             subtitle = {{ subtitle }},
             caption = {{ caption }},
             tag = {{ tag }},
             title.linelength = title.linelength,
             title.colour = title.colour,
             subtitle.linelength = subtitle.linelength,
             subtitle.colour = subtitle.colour,
             na.replace = na.replace,
             na.rm = na.rm,
             facet.position = facet.position,
             facet.fill = facet.fill,
             facet.bold = facet.bold,
             facet.italic = facet.italic,
             facet.size = facet.size,
             facet.margin = facet.margin,
             facet.repeat_lbls_x = facet.repeat_lbls_x,
             facet.repeat_lbls_y = facet.repeat_lbls_y,
             facet.fixed_y = facet.fixed_y,
             facet.fixed_x = facet.fixed_x,
             facet.drop = facet.drop,
             facet.nrow = facet.nrow,
             facet.relative = facet.relative,
             x.date_breaks = x.date_breaks,
             x.date_labels = x.date_labels,
             category.focus = category.focus,
             colour = colour,
             colour_fill = colour_fill,
             colour_opacity = colour_opacity,
             x.lbl_angle = x.lbl_angle,
             x.lbl_align = x.lbl_align,
             x.lbl_italic = x.lbl_italic,
             x.lbl_taxonomy = x.lbl_taxonomy,
             x.remove = x.remove,
             x.position = x.position,
             x.max_items = x.max_items,
             x.max_txt = x.max_txt,
             category.max_items = category.max_items,
             category.max_txt = category.max_txt,
             facet.max_items = facet.max_items,
             facet.max_txt = facet.max_txt,
             x.breaks = x.breaks,
             x.n_breaks = x.n_breaks,
             x.trans = x.trans,
             x.expand = x.expand,
             x.limits = x.limits,
             x.labels = x.labels,
             x.character = x.character,
             x.drop = x.drop,
             x.mic = x.mic,
             x.zoom = x.zoom,
             y.remove = y.remove,
             y.24h = y.24h,
             y.age = y.age,
             y.scientific = y.scientific,
             y.percent = y.percent,
             y.percent_break = y.percent_break,
             y.breaks = y.breaks,
             y.n_breaks = y.n_breaks,
             y.limits = y.limits,
             y.labels = y.labels,
             y.expand = y.expand,
             y.trans = y.trans,
             y.position = y.position,
             y.zoom = y.zoom,
             category.labels = category.labels,
             category.percent = category.percent,
             category.breaks = category.breaks,
             category.limits = category.limits,
             category.expand = category.expand,
             category.midpoint = category.midpoint,
             category.trans = category.trans,
             x.sort = x.sort,
             category.sort = category.sort,
             facet.sort = facet.sort,
             datalabels = {{ datalabels }},
             datalabels.round = datalabels.round,
             datalabels.colour = datalabels.colour,
             datalabels.format = datalabels.format,
             datalabels.colour_fill = datalabels.colour_fill,
             datalabels.size = datalabels.size,
             datalabels.angle = datalabels.angle,
             decimal.mark = decimal.mark,
             big.mark = big.mark,
             summarise_function = summarise_function,
             stacked = stacked,
             stackedpercent = stackedpercent,
             horizontal = horizontal,
             reverse = reverse,
             smooth = smooth,
             smooth.method = smooth.method,
             smooth.formula = smooth.formula,
             smooth.se = smooth.se,
             smooth.level = smooth.level,
             smooth.alpha = smooth.alpha,
             smooth.size = smooth.size,
             smooth.linetype = smooth.linetype,
             size = size,
             linetype = linetype,
             binwidth = binwidth,
             width = width,
             jitter_seed = jitter_seed,
             violin_scale = violin_scale,
             legend.position = legend.position,
             legend.title = {{ legend.title }},
             legend.reverse = legend.reverse,
             legend.barheight = legend.barheight,
             legend.barwidth = legend.barwidth,
             legend.nbin = legend.nbin,
             legend.italic = legend.italic,
             zoom = zoom,
             sep = sep,
             print = print,
             text_factor = text_factor,
             font = font,
             theme = theme,
             background = background,
             markdown = markdown,
             `_misses.x` = missing(x),
             `_misses.y` = missing(y),
             `_misses.category` = missing(category),
             `_misses.facet` = missing(facet),
             `_misses.datalabels` = missing(datalabels),
             `_misses.colour_fill` = missing(colour_fill),
             `_misses.x.title` = missing(x.title),
             `_misses.y.title` = missing(y.title),
             `_misses.title` = missing(title),
             `_misses.subtitle` = missing(subtitle),
             `_misses.tag` = missing(tag),
             `_misses.caption` = missing(caption),
             `_misses.y.percent` = missing(y.percent),
             `_misses.y.percent_break` = missing(y.percent_break),
             `_misses.x.zoom` = missing(x.zoom),
             `_misses.x.max_items` = missing(x.max_items),
             `_misses.facet.fixed_x` = missing(facet.fixed_x),
             `_label.x` = deparse(substitute(x)),
             `_label.y` = deparse(substitute(y)),
             `_label.category` = deparse(substitute(category)),
             `_label.facet` = deparse(substitute(facet)),
             `_summarise_fn_name` = deparse(substitute(summarise_function)),
             ...) 
}

#' @rdname plot2-methods
#' @importFrom dplyr filter mutate select
#' @importFrom tidyr pivot_longer
#' @details For antimicrobial resistance (AMR) data analysis, use the [`bug_drug_combinations()`][AMR::bug_drug_combinations()] or the [`rsi_df()`][AMR::rsi_df()] function from the `AMR` package on a data set with antibiograms. The result can be used as input for [plot2()].
#' @param minimum minimum number of results, defaults to `30`
#' @param remove_intrinsic_resistant a [logical] to indicate that rows with 100% resistance must be removed from the data set before plotting
#' @param language language to be used for antibiotic names
#' @export
plot2.bug_drug_combinations <- function(.data,
                                        x = ab,
                                        y = value,
                                        category = name,
                                        facet = mo,
                                        type = "column",
                                        x.title = FALSE,
                                        y.title = FALSE,
                                        category.title = NULL,
                                        title = NULL,
                                        subtitle = NULL,
                                        caption = NULL,
                                        tag = NULL,
                                        title.linelength = 60,
                                        title.colour = "black",
                                        subtitle.linelength = 60,
                                        subtitle.colour = "grey35",
                                        na.replace = "",
                                        na.rm = FALSE,
                                        facet.position = "top",
                                        facet.fill = NULL,
                                        facet.bold = TRUE,
                                        facet.italic = FALSE,
                                        facet.size = 10,
                                        facet.margin = 8,
                                        facet.repeat_lbls_x = TRUE,
                                        facet.repeat_lbls_y = TRUE,
                                        facet.fixed_y = NULL,
                                        facet.fixed_x = TRUE,
                                        facet.drop = FALSE,
                                        facet.nrow = NULL,
                                        facet.relative = FALSE,
                                        x.date_breaks = NULL,
                                        x.date_labels = NULL,
                                        category.focus = NULL,
                                        colour = "certe_rsi2",
                                        colour_fill = NULL,
                                        colour_opacity = 0,
                                        x.lbl_angle = ifelse(horizontal, 0, 90),
                                        x.lbl_align = NULL,
                                        x.lbl_italic = FALSE,
                                        x.lbl_taxonomy = TRUE,
                                        x.remove = FALSE,
                                        x.position = "bottom",
                                        x.max_items = Inf,
                                        x.max_txt = "(rest, x%n)",
                                        category.max_items = Inf,
                                        category.max_txt = "(rest, x%n)",
                                        facet.max_items = Inf,
                                        facet.max_txt = "(rest, x%n)",
                                        x.breaks = NULL,
                                        x.n_breaks = NULL,
                                        x.trans = "identity",
                                        x.expand = NULL,
                                        x.limits = NULL,
                                        x.labels = NULL,
                                        x.character = NULL,
                                        x.drop = FALSE,
                                        x.mic = FALSE,
                                        x.zoom = FALSE,
                                        y.remove = FALSE,
                                        y.24h = FALSE,
                                        y.age = FALSE,
                                        y.scientific = NULL,
                                        y.percent = FALSE,
                                        y.percent_break = 0.1,
                                        y.breaks = NULL,
                                        y.n_breaks = NULL,
                                        y.limits = NULL,
                                        y.labels = NULL,
                                        y.expand = NULL,
                                        y.trans = "identity",
                                        y.position = "left",
                                        y.zoom = FALSE,
                                        category.labels = NULL,
                                        category.percent = FALSE,
                                        category.breaks = NULL,
                                        category.limits = NULL,
                                        category.expand = 0,
                                        category.midpoint = NULL,
                                        category.trans = "identity",
                                        x.sort = NULL,
                                        category.sort = FALSE,
                                        facet.sort = TRUE,
                                        datalabels = TRUE,
                                        datalabels.round = ifelse(y.percent, 2, 1),
                                        datalabels.format = "%n",
                                        datalabels.colour = "grey25",
                                        datalabels.colour_fill = NULL,
                                        datalabels.size = (3 * text_factor),
                                        datalabels.angle = 0,
                                        decimal.mark = ",",
                                        big.mark = ifelse(decimal.mark == ",", ".", ","),
                                        summarise_function = base::sum,
                                        stacked = FALSE,
                                        stackedpercent = TRUE,
                                        horizontal = TRUE,
                                        reverse = TRUE,
                                        smooth = NULL,
                                        smooth.method = NULL,
                                        smooth.formula = NULL,
                                        smooth.se = TRUE,
                                        smooth.level = 0.95,
                                        smooth.alpha = 0.1,
                                        smooth.size = 0.75,
                                        smooth.linetype = 3,
                                        size = NULL,
                                        linetype = 1,
                                        binwidth = NULL,
                                        width = NULL,
                                        jitter_seed = NA,
                                        violin_scale = "count",
                                        legend.position = NULL,
                                        legend.title = NULL, # TRUE in numeric categories
                                        legend.reverse = FALSE,
                                        legend.barheight = 6,
                                        legend.barwidth = 1.5,
                                        legend.nbin = 300,
                                        legend.italic = FALSE,
                                        zoom = FALSE,
                                        sep = " / ",
                                        print = FALSE,
                                        text_factor = 1,
                                        font = getOption("plot2.font"),
                                        theme = getOption("plot2.theme", "theme_minimal2"),
                                        background = "white",
                                        markdown = TRUE,
                                        minimum = 30,
                                        remove_intrinsic_resistant = TRUE,
                                        language = "nl",
                                        ...) {
  
  ab_name <- getExportedValue(name = "ab_name", ns = asNamespace("AMR"))
  
  df <- .data
  if (isTRUE(remove_intrinsic_resistant)) {
    df <- df |> 
      filter(total != R)
  }
  df <- df |> 
    filter(total >= minimum) |> 
    select(-total) |>
    mutate(ab = ab_name(ab, language = language)) |> 
    pivot_longer(-c(mo, ab))
  df$name <- factor(df$name, levels = c("S", "I", "R"), ordered = TRUE)
  
  plot2_exec(.data = df,
             x = {{ x }},
             y = {{ y }},
             category = {{ category }},
             facet = {{ facet }},
             type = type,
             x.title = {{ x.title }},
             y.title = {{ y.title }},
             category.title = {{ category.title }},
             title = {{ title }},
             subtitle = {{ subtitle }},
             caption = {{ caption }},
             tag = {{ tag }},
             title.linelength = title.linelength,
             title.colour = title.colour,
             subtitle.linelength = subtitle.linelength,
             subtitle.colour = subtitle.colour,
             na.replace = na.replace,
             na.rm = na.rm,
             facet.position = facet.position,
             facet.fill = facet.fill,
             facet.bold = facet.bold,
             facet.italic = facet.italic,
             facet.size = facet.size,
             facet.margin = facet.margin,
             facet.repeat_lbls_x = facet.repeat_lbls_x,
             facet.repeat_lbls_y = facet.repeat_lbls_y,
             facet.fixed_y = facet.fixed_y,
             facet.fixed_x = facet.fixed_x,
             facet.drop = facet.drop,
             facet.nrow = facet.nrow,
             facet.relative = facet.relative,
             x.date_breaks = x.date_breaks,
             x.date_labels = x.date_labels,
             category.focus = category.focus,
             colour = colour,
             colour_fill = colour_fill,
             colour_opacity = colour_opacity,
             x.lbl_angle = x.lbl_angle,
             x.lbl_align = x.lbl_align,
             x.lbl_italic = x.lbl_italic,
             x.lbl_taxonomy = x.lbl_taxonomy,
             x.remove = x.remove,
             x.position = x.position,
             x.max_items = x.max_items,
             x.max_txt = x.max_txt,
             category.max_items = category.max_items,
             category.max_txt = category.max_txt,
             facet.max_items = facet.max_items,
             facet.max_txt = facet.max_txt,
             x.breaks = x.breaks,
             x.n_breaks = x.n_breaks,
             x.trans = x.trans,
             x.expand = x.expand,
             x.limits = x.limits,
             x.labels = x.labels,
             x.character = x.character,
             x.drop = x.drop,
             x.mic = x.mic,
             x.zoom = x.zoom,
             y.remove = y.remove,
             y.24h = y.24h,
             y.age = y.age,
             y.scientific = y.scientific,
             y.percent = y.percent,
             y.percent_break = y.percent_break,
             y.breaks = y.breaks,
             y.n_breaks = y.n_breaks,
             y.limits = y.limits,
             y.labels = y.labels,
             y.expand = y.expand,
             y.trans = y.trans,
             y.position = y.position,
             y.zoom = y.zoom,
             category.labels = category.labels,
             category.percent = category.percent,
             category.breaks = category.breaks,
             category.limits = category.limits,
             category.expand = category.expand,
             category.midpoint = category.midpoint,
             category.trans = category.trans,
             x.sort = x.sort,
             category.sort = category.sort,
             facet.sort = facet.sort,
             datalabels = {{ datalabels }},
             datalabels.round = datalabels.round,
             datalabels.colour = datalabels.colour,
             datalabels.format = datalabels.format,
             datalabels.colour_fill = datalabels.colour_fill,
             datalabels.size = datalabels.size,
             datalabels.angle = datalabels.angle,
             decimal.mark = decimal.mark,
             big.mark = big.mark,
             summarise_function = summarise_function,
             stacked = stacked,
             stackedpercent = stackedpercent,
             horizontal = horizontal,
             reverse = reverse,
             smooth = smooth,
             smooth.method = smooth.method,
             smooth.formula = smooth.formula,
             smooth.se = smooth.se,
             smooth.level = smooth.level,
             smooth.alpha = smooth.alpha,
             smooth.size = smooth.size,
             smooth.linetype = smooth.linetype,
             size = size,
             linetype = linetype,
             binwidth = binwidth,
             width = width,
             jitter_seed = jitter_seed,
             violin_scale = violin_scale,
             legend.position = legend.position,
             legend.title = {{ legend.title }},
             legend.reverse = legend.reverse,
             legend.barheight = legend.barheight,
             legend.barwidth = legend.barwidth,
             legend.nbin = legend.nbin,
             legend.italic = legend.italic,
             zoom = zoom,
             sep = sep,
             print = print,
             text_factor = text_factor,
             font = font,
             theme = theme,
             background = background,
             markdown = markdown,
             `_misses.x` = missing(x),
             `_misses.y` = missing(y),
             `_misses.category` = missing(category),
             `_misses.facet` = missing(facet),
             `_misses.datalabels` = missing(datalabels),
             `_misses.colour_fill` = missing(colour_fill),
             `_misses.x.title` = FALSE,
             `_misses.y.title` = FALSE,
             `_misses.title` = missing(title),
             `_misses.subtitle` = missing(subtitle),
             `_misses.tag` = missing(tag),
             `_misses.caption` = missing(caption),
             `_misses.y.percent` = missing(y.percent),
             `_misses.y.percent_break` = missing(y.percent_break),
             `_misses.x.zoom` = missing(x.zoom),
             `_misses.x.max_items` = missing(x.max_items),
             `_misses.facet.fixed_x` = missing(facet.fixed_x),
             `_label.x` = deparse(substitute(x)),
             `_label.y` = deparse(substitute(y)),
             `_label.category` = deparse(substitute(category)),
             `_label.facet` = deparse(substitute(facet)),
             `_summarise_fn_name` = deparse(substitute(summarise_function)),
             ...) 
}

#' @rdname plot2-methods
#' @export
plot2.rsi_df <- function(.data,
                         x = NULL,
                         y = isolates,
                         category = interpretation,
                         facet = antibiotic,
                         type = "column",
                         x.title = TRUE,
                         y.title = FALSE,
                         category.title = NULL,
                         title = FALSE,
                         subtitle = NULL,
                         caption = NULL,
                         tag = NULL,
                         title.linelength = 60,
                         title.colour = "black",
                         subtitle.linelength = 60,
                         subtitle.colour = "grey35",
                         na.replace = "",
                         na.rm = FALSE,
                         facet.position = "top",
                         facet.fill = NULL,
                         facet.bold = TRUE,
                         facet.italic = FALSE,
                         facet.size = 10,
                         facet.margin = 8,
                         facet.repeat_lbls_x = TRUE,
                         facet.repeat_lbls_y = TRUE,
                         facet.fixed_y = NULL,
                         facet.fixed_x = TRUE,
                         facet.drop = FALSE,
                         facet.nrow = NULL,
                         facet.relative = FALSE,
                         x.date_breaks = NULL,
                         x.date_labels = NULL,
                         category.focus = NULL,
                         colour = "certe_rsi2",
                         colour_fill = NULL,
                         colour_opacity = 0,
                         x.lbl_angle = 0,
                         x.lbl_align = NULL,
                         x.lbl_italic = FALSE,
                         x.lbl_taxonomy = TRUE,
                         x.remove = FALSE,
                         x.position = "bottom",
                         x.max_items = Inf,
                         x.max_txt = "(rest, x%n)",
                         category.max_items = Inf,
                         category.max_txt = "(rest, x%n)",
                         facet.max_items = Inf,
                         facet.max_txt = "(rest, x%n)",
                         x.breaks = NULL,
                         x.n_breaks = NULL,
                         x.trans = "identity",
                         x.expand = NULL,
                         x.limits = NULL,
                         x.labels = NULL,
                         x.character = NULL,
                         x.drop = FALSE,
                         x.mic = FALSE,
                         x.zoom = FALSE,
                         y.remove = FALSE,
                         y.24h = FALSE,
                         y.age = FALSE,
                         y.scientific = NULL,
                         y.percent = FALSE,
                         y.percent_break = 0.1,
                         y.breaks = NULL,
                         y.n_breaks = NULL,
                         y.limits = NULL,
                         y.labels = NULL,
                         y.expand = NULL,
                         y.trans = "identity",
                         y.position = "left",
                         y.zoom = FALSE,
                         category.labels = NULL,
                         category.percent = FALSE,
                         category.breaks = NULL,
                         category.limits = NULL,
                         category.expand = 0,
                         category.midpoint = NULL,
                         category.trans = "identity",
                         x.sort = NULL,
                         category.sort = FALSE,
                         facet.sort = TRUE,
                         datalabels = TRUE,
                         datalabels.round = ifelse(y.percent, 2, 1),
                         datalabels.format = "%n",
                         datalabels.colour = "grey25",
                         datalabels.colour_fill = NULL,
                         datalabels.size = (3 * text_factor),
                         datalabels.angle = 0,
                         decimal.mark = ",",
                         big.mark = ifelse(decimal.mark == ",", ".", ","),
                         summarise_function = base::sum,
                         stacked = FALSE,
                         stackedpercent = TRUE,
                         horizontal = FALSE,
                         reverse = TRUE,
                         smooth = NULL,
                         smooth.method = NULL,
                         smooth.formula = NULL,
                         smooth.se = TRUE,
                         smooth.level = 0.95,
                         smooth.alpha = 0.1,
                         smooth.size = 0.75,
                         smooth.linetype = 3,
                         size = NULL,
                         linetype = 1,
                         binwidth = NULL,
                         width = NULL,
                         jitter_seed = NA,
                         violin_scale = "count",
                         legend.position = NULL,
                         legend.title = NULL, # TRUE in numeric categories
                         legend.reverse = FALSE,
                         legend.barheight = 6,
                         legend.barwidth = 1.5,
                         legend.nbin = 300,
                         legend.italic = FALSE,
                         zoom = FALSE,
                         sep = " / ",
                         print = FALSE,
                         text_factor = 1,
                         font = getOption("plot2.font"),
                         theme = getOption("plot2.theme", "theme_minimal2"),
                         background = "white",
                         markdown = TRUE,
                         ...) {
  
  if (!"isolates" %in% colnames(.data) && !is.integer(.data$value)) {
    stop("isolate count not available, use AMR::rsi_df() or AMR::count_df() before plotting", call. = FALSE)
  } else if (is.integer(.data$value)) {
    .data$isolates <- .data$value
  }
  
  plot2_exec(.data = .data,
             x = {{ x }},
             y = {{ y }},
             category = {{ category }},
             facet = {{ facet }},
             type = type,
             x.title = {{ x.title }},
             y.title = {{ y.title }},
             category.title = {{ category.title }},
             title = {{ title }},
             subtitle = {{ subtitle }},
             caption = {{ caption }},
             tag = {{ tag }},
             title.linelength = title.linelength,
             title.colour = title.colour,
             subtitle.linelength = subtitle.linelength,
             subtitle.colour = subtitle.colour,
             na.replace = na.replace,
             na.rm = na.rm,
             facet.position = facet.position,
             facet.fill = facet.fill,
             facet.bold = facet.bold,
             facet.italic = facet.italic,
             facet.size = facet.size,
             facet.margin = facet.margin,
             facet.repeat_lbls_x = facet.repeat_lbls_x,
             facet.repeat_lbls_y = facet.repeat_lbls_y,
             facet.fixed_y = facet.fixed_y,
             facet.fixed_x = facet.fixed_x,
             facet.drop = facet.drop,
             facet.nrow = facet.nrow,
             facet.relative = facet.relative,
             x.date_breaks = x.date_breaks,
             x.date_labels = x.date_labels,
             category.focus = category.focus,
             colour = colour,
             colour_fill = colour_fill,
             colour_opacity = colour_opacity,
             x.lbl_angle = x.lbl_angle,
             x.lbl_align = x.lbl_align,
             x.lbl_italic = x.lbl_italic,
             x.lbl_taxonomy = x.lbl_taxonomy,
             x.remove = x.remove,
             x.position = x.position,
             x.max_items = x.max_items,
             x.max_txt = x.max_txt,
             category.max_items = category.max_items,
             category.max_txt = category.max_txt,
             facet.max_items = facet.max_items,
             facet.max_txt = facet.max_txt,
             x.breaks = x.breaks,
             x.n_breaks = x.n_breaks,
             x.trans = x.trans,
             x.expand = x.expand,
             x.limits = x.limits,
             x.labels = x.labels,
             x.character = x.character,
             x.drop = x.drop,
             x.mic = x.mic,
             x.zoom = x.zoom,
             y.remove = y.remove,
             y.24h = y.24h,
             y.age = y.age,
             y.scientific = y.scientific,
             y.percent = y.percent,
             y.percent_break = y.percent_break,
             y.breaks = y.breaks,
             y.n_breaks = y.n_breaks,
             y.limits = y.limits,
             y.labels = y.labels,
             y.expand = y.expand,
             y.trans = y.trans,
             y.position = y.position,
             y.zoom = y.zoom,
             category.labels = category.labels,
             category.percent = category.percent,
             category.breaks = category.breaks,
             category.limits = category.limits,
             category.expand = category.expand,
             category.midpoint = category.midpoint,
             category.trans = category.trans,
             x.sort = x.sort,
             category.sort = category.sort,
             facet.sort = facet.sort,
             datalabels = {{ datalabels }},
             datalabels.round = datalabels.round,
             datalabels.colour = datalabels.colour,
             datalabels.format = datalabels.format,
             datalabels.colour_fill = datalabels.colour_fill,
             datalabels.size = datalabels.size,
             datalabels.angle = datalabels.angle,
             decimal.mark = decimal.mark,
             big.mark = big.mark,
             summarise_function = summarise_function,
             stacked = stacked,
             stackedpercent = stackedpercent,
             horizontal = horizontal,
             reverse = reverse,
             smooth = smooth,
             smooth.method = smooth.method,
             smooth.formula = smooth.formula,
             smooth.se = smooth.se,
             smooth.level = smooth.level,
             smooth.alpha = smooth.alpha,
             smooth.size = smooth.size,
             smooth.linetype = smooth.linetype,
             size = size,
             linetype = linetype,
             binwidth = binwidth,
             width = width,
             jitter_seed = jitter_seed,
             violin_scale = violin_scale,
             legend.position = legend.position,
             legend.title = {{ legend.title }},
             legend.reverse = legend.reverse,
             legend.barheight = legend.barheight,
             legend.barwidth = legend.barwidth,
             legend.nbin = legend.nbin,
             legend.italic = legend.italic,
             zoom = zoom,
             sep = sep,
             print = print,
             text_factor = text_factor,
             font = font,
             theme = theme,
             background = background,
             markdown = markdown,
             `_misses.x` = missing(x),
             `_misses.y` = missing(y),
             `_misses.category` = missing(category),
             `_misses.facet` = missing(facet),
             `_misses.datalabels` = missing(datalabels),
             `_misses.colour_fill` = missing(colour_fill),
             `_misses.x.title` = FALSE,
             `_misses.y.title` = FALSE,
             `_misses.title` = missing(title) && !isFALSE(title),
             `_misses.subtitle` = missing(subtitle),
             `_misses.tag` = missing(tag),
             `_misses.caption` = missing(caption),
             `_misses.y.percent` = missing(y.percent),
             `_misses.y.percent_break` = missing(y.percent_break),
             `_misses.x.zoom` = missing(x.zoom),
             `_misses.x.max_items` = missing(x.max_items),
             `_misses.facet.fixed_x` = missing(facet.fixed_x),
             `_label.x` = deparse(substitute(x)),
             `_label.y` = deparse(substitute(y)),
             `_label.category` = deparse(substitute(category)),
             `_label.facet` = deparse(substitute(facet)),
             `_summarise_fn_name` = deparse(substitute(summarise_function)),
             ...) 
}

#' @rdname plot2-methods
#' @importFrom ggplot2 geom_hline geom_point geom_line element_text
#' @importFrom certestyle colourpicker
#' @details The QC-test can be acquired with [certestats::qc_test()]. It applies the Nelson QC rules for a vector of values.
#' @export
plot2.qc_test <- function(.data,
                          x = x,
                          y = y,
                          category = rule,
                          facet = NULL,
                          type = "point",
                          x.title = "Index",
                          y.title = "Value",
                          category.title = NULL,
                          title = paste0("QC Chart (", attributes(.data)$guideline, ")"),
                          subtitle = NULL,
                          caption = NULL,
                          tag = NULL,
                          title.linelength = 60,
                          title.colour = "black",
                          subtitle.linelength = 60,
                          subtitle.colour = "grey35",
                          na.replace = "",
                          na.rm = FALSE,
                          facet.position = "top",
                          facet.fill = NULL,
                          facet.bold = TRUE,
                          facet.italic = FALSE,
                          facet.size = 10,
                          facet.margin = 8,
                          facet.repeat_lbls_x = TRUE,
                          facet.repeat_lbls_y = TRUE,
                          facet.fixed_y = NULL,
                          facet.fixed_x = TRUE,
                          facet.drop = FALSE,
                          facet.nrow = NULL,
                          facet.relative = FALSE,
                          x.date_breaks = NULL,
                          x.date_labels = NULL,
                          category.focus = NULL,
                          colour = colourpicker(c("Observation" = "grey75",
                                                  "Rule 1" = "certeblauw",
                                                  "Rule 2" = "certegroen",
                                                  "Rule 3" = "certeroze",
                                                  "Rule 4" = "certegeel",
                                                  "Rule 5" = "certelila",
                                                  "Rule 6" = "certezachtlila",
                                                  "Rule 7" = "certeblauw2",
                                                  "Rule 8" = "certegroen2")),
                          colour_fill = NULL,
                          colour_opacity = 0,
                          x.lbl_angle = 0,
                          x.lbl_align = NULL,
                          x.lbl_italic = FALSE,
                          x.lbl_taxonomy = FALSE,
                          x.remove = FALSE,
                          x.position = "bottom",
                          x.max_items = Inf,
                          x.max_txt = "(rest, x%n)",
                          category.max_items = Inf,
                          category.max_txt = "(rest, x%n)",
                          facet.max_items = Inf,
                          facet.max_txt = "(rest, x%n)",
                          x.breaks = NULL,
                          x.n_breaks = NULL,
                          x.trans = "identity",
                          x.expand = NULL,
                          x.limits = NULL,
                          x.labels = NULL,
                          x.character = NULL,
                          x.drop = FALSE,
                          x.mic = FALSE,
                          x.zoom = TRUE,
                          y.remove = FALSE,
                          y.24h = FALSE,
                          y.age = FALSE,
                          y.scientific = NULL,
                          y.percent = FALSE,
                          y.percent_break = 0.1,
                          y.breaks = NULL,
                          y.n_breaks = NULL,
                          y.limits = NULL,
                          y.labels = NULL,
                          y.expand = NULL,
                          y.trans = "identity",
                          y.position = "left",
                          y.zoom = TRUE,
                          category.labels = NULL,
                          category.percent = FALSE,
                          category.breaks = NULL,
                          category.limits = NULL,
                          category.expand = 0,
                          category.midpoint = NULL,
                          category.trans = "identity",
                          x.sort = NULL,
                          category.sort = TRUE,
                          facet.sort = TRUE,
                          datalabels = TRUE,
                          datalabels.round = ifelse(y.percent, 2, 1),
                          datalabels.format = "%n",
                          datalabels.colour = "grey25",
                          datalabels.colour_fill = NULL,
                          datalabels.size = (3 * text_factor),
                          datalabels.angle = 0,
                          decimal.mark = ",",
                          big.mark = ifelse(decimal.mark == ",", ".", ","),
                          summarise_function = base::sum,
                          stacked = FALSE,
                          stackedpercent = FALSE,
                          horizontal = FALSE,
                          reverse = horizontal,
                          smooth = NULL,
                          smooth.method = NULL,
                          smooth.formula = NULL,
                          smooth.se = TRUE,
                          smooth.level = 0.95,
                          smooth.alpha = 0.1,
                          smooth.size = 0.75,
                          smooth.linetype = 3,
                          size = 2,
                          linetype = 1,
                          binwidth = NULL,
                          width = NULL,
                          jitter_seed = NA,
                          violin_scale = "count",
                          legend.position = "right",
                          legend.title = NULL, # TRUE in numeric categories
                          legend.reverse = FALSE,
                          legend.barheight = 6,
                          legend.barwidth = 1.5,
                          legend.nbin = 300,
                          legend.italic = FALSE,
                          zoom = TRUE,
                          sep = " / ",
                          print = FALSE,
                          text_factor = 1,
                          font = getOption("plot2.font"),
                          theme = getOption("plot2.theme", "theme_minimal2"),
                          background = "white",
                          markdown = TRUE,
                          ...) {
  
  att <- attributes(.data)
  df <- data.frame(x = seq_len(length(att$values)),
                   y = att$values,
                   rule = "Observation",
                   shp = 4,
                   size = size,
                   stringsAsFactors = FALSE)
  for (i in seq_len(length(.data))) {
    if (length(.data[[i]]) > 0) {
      # only add the first here
      df_rule <- data.frame(x = .data[[i]],
                            y = att$values[.data[[i]]],
                            rule = paste0("Rule ", gsub("[^0-9]", "", names(.data)[i])),
                            shp = 13,
                            size = size * 1.5,
                            stringsAsFactors = FALSE)
      df <- rbind(df, df_rule)
    }
  }
  
  df <- df[order(df$x, df$rule), , drop = FALSE]
  
  if (missing(caption) && "certestats" %in% rownames(utils::installed.packages())) {
    # fill caption with rules
    qc_rule_text <- getExportedValue("qc_rule_text", ns = asNamespace("certestats"))
    rules <- names(.data[unlist(lapply(.data, function(r) length(r) > 0))])
    rules <- as.integer(gsub("[^0-9]", "", rules))
    threshold <- att$threshold[rules]
    caption <- "\n"
    for (i in seq_len(length(rules))) {
      rule <- paste0("Rule ", rules[i], ":")
      caption <- c(caption, 
                   paste(rule, qc_rule_text(rules[i], threshold[i])))
    }
    caption <- paste0(caption, collapse = "\n")
  }
  
  p <- plot2_exec(.data = df,
                  x = {{ x }},
                  y = {{ y }},
                  category = {{ category }},
                  facet = {{ facet }},
                  type = "blank",
                  x.title = {{ x.title }},
                  y.title = {{ y.title }},
                  category.title = {{ category.title }},
                  title = {{ title }},
                  subtitle = {{ subtitle }},
                  caption = {{ caption }},
                  tag = {{ tag }},
                  title.linelength = title.linelength,
                  title.colour = title.colour,
                  subtitle.linelength = subtitle.linelength,
                  subtitle.colour = subtitle.colour,
                  na.replace = na.replace,
                  na.rm = na.rm,
                  facet.position = facet.position,
                  facet.fill = facet.fill,
                  facet.bold = facet.bold,
                  facet.italic = facet.italic,
                  facet.size = facet.size,
                  facet.margin = facet.margin,
                  facet.repeat_lbls_x = facet.repeat_lbls_x,
                  facet.repeat_lbls_y = facet.repeat_lbls_y,
                  facet.fixed_y = facet.fixed_y,
                  facet.fixed_x = facet.fixed_x,
                  facet.drop = facet.drop,
                  facet.nrow = facet.nrow,
                  facet.relative = facet.relative,
                  x.date_breaks = x.date_breaks,
                  x.date_labels = x.date_labels,
                  category.focus = category.focus,
                  colour = colour,
                  colour_fill = colour_fill,
                  colour_opacity = colour_opacity,
                  x.lbl_angle = x.lbl_angle,
                  x.lbl_align = x.lbl_align,
                  x.lbl_italic = x.lbl_italic,
                  x.lbl_taxonomy = x.lbl_taxonomy,
                  x.remove = x.remove,
                  x.position = x.position,
                  x.max_items = x.max_items,
                  x.max_txt = x.max_txt,
                  category.max_items = category.max_items,
                  category.max_txt = category.max_txt,
                  facet.max_items = facet.max_items,
                  facet.max_txt = facet.max_txt,
                  x.breaks = x.breaks,
                  x.n_breaks = x.n_breaks,
                  x.trans = x.trans,
                  x.expand = x.expand,
                  x.limits = x.limits,
                  x.labels = x.labels,
                  x.character = x.character,
                  x.drop = x.drop,
                  x.mic = x.mic,
                  x.zoom = x.zoom,
                  y.remove = y.remove,
                  y.24h = y.24h,
                  y.age = y.age,
                  y.scientific = y.scientific,
                  y.percent = y.percent,
                  y.percent_break = y.percent_break,
                  y.breaks = y.breaks,
                  y.n_breaks = y.n_breaks,
                  y.limits = y.limits,
                  y.labels = y.labels,
                  y.expand = y.expand,
                  y.trans = y.trans,
                  y.position = y.position,
                  y.zoom = y.zoom,
                  category.labels = category.labels,
                  category.percent = category.percent,
                  category.breaks = category.breaks,
                  category.limits = category.limits,
                  category.expand = category.expand,
                  category.midpoint = category.midpoint,
                  category.trans = category.trans,
                  x.sort = x.sort,
                  category.sort = category.sort,
                  facet.sort = facet.sort,
                  datalabels = {{ datalabels }},
                  datalabels.round = datalabels.round,
                  datalabels.colour = datalabels.colour,
                  datalabels.format = datalabels.format,
                  datalabels.colour_fill = datalabels.colour_fill,
                  datalabels.size = datalabels.size,
                  datalabels.angle = datalabels.angle,
                  decimal.mark = decimal.mark,
                  big.mark = big.mark,
                  summarise_function = summarise_function,
                  stacked = stacked,
                  stackedpercent = stackedpercent,
                  horizontal = horizontal,
                  reverse = reverse,
                  smooth = smooth,
                  smooth.method = smooth.method,
                  smooth.formula = smooth.formula,
                  smooth.se = smooth.se,
                  smooth.level = smooth.level,
                  smooth.alpha = smooth.alpha,
                  smooth.size = smooth.size,
                  smooth.linetype = smooth.linetype,
                  size = size,
                  linetype = linetype,
                  binwidth = binwidth,
                  width = width,
                  jitter_seed = jitter_seed,
                  violin_scale = violin_scale,
                  legend.position = legend.position,
                  legend.title = {{ legend.title }},
                  legend.reverse = legend.reverse,
                  legend.barheight = legend.barheight,
                  legend.barwidth = legend.barwidth,
                  legend.nbin = legend.nbin,
                  legend.italic = legend.italic,
                  zoom = zoom,
                  sep = sep,
                  print = FALSE,
                  text_factor = text_factor,
                  font = font,
                  theme = theme,
                  background = background,
                  markdown = markdown,
                  `_misses.x` = FALSE,
                  `_misses.y` = FALSE,
                  `_misses.category` = FALSE,
                  `_misses.facet` = missing(facet),
                  `_misses.datalabels` = missing(datalabels),
                  `_misses.colour_fill` = missing(colour_fill),
                  `_misses.x.title` = FALSE,
                  `_misses.y.title` = FALSE,
                  `_misses.title` = FALSE,
                  `_misses.subtitle` = missing(subtitle),
                  `_misses.tag` = missing(tag),
                  `_misses.caption` = FALSE,
                  `_misses.y.percent` = missing(y.percent),
                  `_misses.y.percent_break` = missing(y.percent_break),
                  `_misses.x.zoom` = missing(x.zoom),
                  `_misses.x.max_items` = missing(x.max_items),
                  `_misses.facet.fixed_x` = missing(facet.fixed_x),
                  `_label.x` = deparse(substitute(x)),
                  `_label.y` = deparse(substitute(y)),
                  `_label.category` = deparse(substitute(category)),
                  `_label.facet` = deparse(substitute(facet)),
                  `_summarise_fn_name` = deparse(substitute(summarise_function)),
                  ...)
  
  # left align the rule texts
  p <- p + theme(plot.caption = element_text(hjust = 0))
  
  # add reference lines
  p <- p +
    geom_hline(yintercept = mean(att$values),
               colour = "black", linetype = 2, size = size / 2.5) +
    geom_hline(yintercept = mean(att$values) + stats::sd(att$values),
               colour = "#61D04F", linetype = 2, size = size / 2.5) +
    geom_hline(yintercept = mean(att$values) - stats::sd(att$values),
               colour = "#61D04F", linetype = 2, size = size / 2.5) +
    geom_hline(yintercept = mean(att$values) + 2 * stats::sd(att$values),
               colour = "#F5C710", linetype = 2, size = size / 2.5) +
    geom_hline(yintercept = mean(att$values) - 2 * stats::sd(att$values),
               colour = "#F5C710", linetype = 2, size = size / 2.5) +
    geom_hline(yintercept = mean(att$values) + 3 * stats::sd(att$values),
               colour = "#DF536B", linetype = 2, size = size / 2.5) +
    geom_hline(yintercept = mean(att$values) - 3 * stats::sd(att$values),
               colour = "#DF536B", linetype = 2, size = size / 2.5)
  
  p <- p +
    geom_point(shape = df$shp, size = df$size)
  
  # add lines for each rule found
  for (i in seq_len(length(.data))) {
    if (length(.data[[i]]) > 0) {
      threshold <- att$threshold[i]
      ind <- .data[[i]]
      p <- p +
        geom_point(data = data.frame(x = ind,
                                     y = att$values[ind]),
                   mapping = aes_string("x", "y"),
                   inherit.aes = FALSE,
                   alpha = 0.33,
                   size = size * 2.5,
                   colour = colour[i + 1])
      if (threshold > 1) {
        # print coloured lines and point for the rules
        for (j in seq_len(length(ind))) {
          ind_vector <- c(ind[j]:(ind[j] + threshold - 1))
          val <- att$values[ind_vector]
          p <- p +
            geom_line(data = data.frame(x = ind_vector,
                                        y = val),
                      mapping = aes_string("x", "y"),
                      inherit.aes = FALSE,
                      size = size / 3,
                      linetype = linetype,
                      colour = colour[i + 1]) +
            geom_point(data = data.frame(x = ind_vector,
                                         y = val),
                       mapping = aes_string("x", "y"),
                       inherit.aes = FALSE,
                       shape = 4,
                       size = size,
                       colour = colour[i + 1])
        }
      }
    }
  }
  if (isTRUE(print)) {
    print(p)
  } else {
    p
  }
}
